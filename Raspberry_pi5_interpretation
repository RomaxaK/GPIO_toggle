import tkinter as tk
import serial
import threading

# --- Serial Settings ---
SERIAL_PORT = 'COM6'      # Update this to your correct port
BAUD_RATE = 115200

class SerialReader(threading.Thread):
    def __init__(self, callback):
        super().__init__(daemon=True)
        self.callback = callback
        self.ser = serial.Serial(SERIAL_PORT, BAUD_RATE)
    
    def run(self):
        while True:
            try:
                line = self.ser.readline().decode(errors='ignore').strip()
                print(f"RAW: {line}")  # Optional: shows full line in terminal

                if line.startswith("STATS"):
                    # Format: STATS,<request_count>,<grant_count>
                    _, request_str, grant_str = line.split(',')
                    requests = int(request_str.strip())
                    grants = int(grant_str.strip())
                    self.callback(requests, grants)
            except Exception as e:
                print(f"Serial error: {e}")

class StatsGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("ESP32 Request/Grant Monitor")

        # --- Request Label ---
        self.request_label = tk.Label(root, text="Requests: 0", font=("Arial", 18))
        self.request_label.pack(pady=10)

        # --- Grant Label ---
        self.grant_label = tk.Label(root, text="Grants: 0", font=("Arial", 18))
        self.grant_label.pack(pady=10)

        # --- Start Serial Reader Thread ---
        self.reader = SerialReader(self.update_stats)
        self.reader.start()

    def update_stats(self, requests, grants):
        self.request_label.config(text=f"Requests: {requests}")
        self.grant_label.config(text=f"Grants: {grants}")

if __name__ == "__main__":
    root = tk.Tk()
    app = StatsGUI(root)
    root.mainloop()
